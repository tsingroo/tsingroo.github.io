---
author: tsingroo
date: 2011-11-09 14:27:41+00:00
layout: post
title: '[转]Twitter新的搜索架构'
---

翻译：[http://article.yeeyan.org/view/yangxiao/141679](http://article.yeeyan.org/view/yangxiao/141679)


如果做得不错的话，大部分人不会意识到在过去的几个星期里，我们已经发布了twitter.com新的搜索后台！我们一个主要的目标，也是最大的挑战，即是在不当机或者造成搜索结果不便的情况下，用新的架构替换掉老的。下<!-- more -->面看看我们改了哪些东西，以及为什么要改。

Twitter的实时搜索引擎，直到最近才放弃使用Summize开发的技术。自从收购Summize公司以来，Twtter获得了惊人的爆炸式成长。而如何拓展之前基于MySQL的系统变得越来越具有挑战。


## 新技术
大约6个月前，我们决定开发一个全新的现代搜索框架，该搜索框架基于高性能的倒排索引，而非关系型数据库。因为热爱开源，所以我们选择了Lucene——一个用Java写的搜索引擎库作为开发源型。

新系统的需求是巨大的：每秒超过1,000条推和12,000个查询 = 每天超过10亿个查询(!)，已经让我们的系统不堪重负。我们计划新的系统将会使用几年，所以目标是至少支持多一个数量级的负载。

Twitter是实时的，所以我们的搜索引擎也必须实时。除了满足可伸缩性的需求，我们还需要支持小于10秒的超低索引延时(从一条推发出到它可被搜索的时间)。由于索引器本身只是推消息处理过程中的一个环节，所以光索引器本身的延时必须保证在亚秒级别。是的，在Twitter我们就是喜欢诸如此类的挑战！(如果你也喜欢，联系[@JoinTheFlock](http://twitter.com/jointheflock)!)


## 改进过的Lucene


Lucene是伟大的，但是它现在的方法在实时搜索上还存在几个缺陷。这也是我们为什么在保持Lucene标准接口的情况下，重写了大部分的核心内存数据结构，尤其是Posting Lists结构。这使我们在使用Lucene时几乎不用修改。我们的修改包括：
  * 大大改进了垃圾回收的效率
  * 无锁(lock-free)数据结构和算法
  * 能反向遍历的posting lists
  * 高效的查询早结束功能

我们相信这些修改背后的框架所涉及到的一些有趣话题同样适用于普通的软件工程(不只是搜索)。我们希望以后能与大家分享更多的改进。

而且，在大家要求之前，我们已经计划将所有的修改贡献给Lucene；有一些代码已经写入Lucene最新的开发分支，和新的实时版本。


## 好处
现在系统已经在运行，结果让我们很兴奋。计算得出，现在只用了大约5%的后台系统资源，这意味着我们还有很多余地。新的索引器能支持每秒比当前信息多50倍的数据量！并且新系统运行平稳，完全没有任何问题和不稳定(运气不错)。

但是你也许会想：好吧，是快了，你们可以支持更大的索引了，但是这对用户有什么好处？回答是：当然有！你能发现的第一个区别是现在的索引比以前大了，几乎是原来的2倍，但是搜索速度并没有变慢。而且，最重要的是，新的系统有很强的通用性和可扩展性，使我们可以更快更好地开发牛叉的新功能。拭目以待吧！

开发该搜素引擎的工程师: [Michael Busch](http://twitter.com/michibusch), [Krishna Gade](http://twitter.com/krishnagade), [Mike Hayes](http://twitter.com/JugglingPumba), [Abhi Khune](http://twitter.com/akhune), [Brian Larson](http://twitter.com/larsonite), [Patrick Lok](http://twitter.com/plok), [Samuel Luckenbill](http://twitter.com/sam),

[Jake Mannix](http://twitter.com/pbrane), [Jonathan Reichhold](http://twitter.com/jreichhold).
